<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üîç Authentication & Dashboard Debug Tool</h1>
    
    <div class="section info">
        <h2>Step 1: Test Login</h2>
        <div>
            <label>Username: <input type="text" id="username" value="staff_user" /></label><br/><br/>
            <label>Password: <input type="password" id="password" value="testpass123" /></label><br/><br/>
            <button onclick="testLogin()">Test Login</button>
        </div>
    </div>

    <div class="section info">
        <h2>Step 2: Check Storage</h2>
        <button onclick="checkStorage()">Check LocalStorage</button>
        <button onclick="clearStorage()">Clear Storage</button>
    </div>

    <div class="section info">
        <h2>Step 3: Test API Calls</h2>
        <button onclick="testDashboardAPI()">Test Dashboard API</button>
        <button onclick="testWithToken()">Test Authenticated Request</button>
    </div>

    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        const results = document.getElementById('results');

        function addResult(title, data, type = 'info') {
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <pre>${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}</pre>
            `;
            results.prepend(div);
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                addResult('Login Request', { username, password: '***' }, 'info');
                
                const response = await fetch(`${API_BASE}/auth/token/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Store tokens like the app does
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    addResult('‚úÖ Login Successful', {
                        status: response.status,
                        user: data.user,
                        hasAccessToken: !!data.access,
                        hasRefreshToken: !!data.refresh
                    }, 'success');
                } else {
                    addResult('‚ùå Login Failed', {
                        status: response.status,
                        error: data
                    }, 'error');
                }
            } catch (error) {
                addResult('‚ùå Login Error', error.message, 'error');
            }
        }

        function checkStorage() {
            const storage = {
                access_token: localStorage.getItem('access_token'),
                refresh_token: localStorage.getItem('refresh_token'),
                user: localStorage.getItem('user')
            };

            let parsed = null;
            try {
                if (storage.user) {
                    parsed = JSON.parse(storage.user);
                }
            } catch (e) {
                addResult('‚ùå Invalid User Data in Storage', e.message, 'error');
                return;
            }

            const status = storage.access_token ? 'success' : 'error';
            addResult('LocalStorage Check', {
                hasAccessToken: !!storage.access_token,
                hasRefreshToken: !!storage.refresh_token,
                hasUser: !!storage.user,
                user: parsed,
                accessTokenLength: storage.access_token?.length || 0
            }, status);
        }

        function clearStorage() {
            localStorage.clear();
            addResult('Storage Cleared', 'All localStorage items removed', 'info');
        }

        async function testDashboardAPI() {
            try {
                // Test requests API
                const response = await fetch(`${API_BASE}/purchases/requests/?page_size=100`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ Dashboard API Success', {
                        status: response.status,
                        totalRequests: data.count || 0,
                        results: data.results?.length || 0
                    }, 'success');
                } else {
                    addResult('‚ùå Dashboard API Failed', {
                        status: response.status,
                        error: data
                    }, 'error');
                }
            } catch (error) {
                addResult('‚ùå Dashboard API Error', error.message, 'error');
            }
        }

        async function testWithToken() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                addResult('‚ùå No Token', 'Please login first', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/core/health/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    addResult('‚úÖ Authenticated Request Success', {
                        status: response.status,
                        data: data
                    }, 'success');
                } else {
                    addResult('‚ùå Authenticated Request Failed', {
                        status: response.status,
                        error: data,
                        message: response.status === 401 ? 'Token expired or invalid' : 'Unknown error'
                    }, 'error');
                }
            } catch (error) {
                addResult('‚ùå Request Error', error.message, 'error');
            }
        }

        // Auto-check storage on load
        window.addEventListener('load', () => {
            checkStorage();
        });
    </script>
</body>
</html>
